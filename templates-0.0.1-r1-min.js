(function(g,c){function e(x,w){var y=x[w];return function(){return y.apply(x,arguments)}}function r(w){return w}function p(w,y){var x={};w.map(function(z){if(z.name in x){if(y.isArray(x[z.name])){x[z.name].push(z.value)}else{x[z.name]=[x[z.name],z.value]}}else{x[z.name]=z.value}});return x}function j(z){var y=[];var w=[];for(n in z){y.push(n)}for(i in z[y[0]]){var x={};for(k in y){x[y[k]]=z[y[k]][i]}w.push(x)}return w}function u(x,w){for(m in x){if((m in w)&&(typeof w[m]==="function")){x[m]=e(w,m)}}return x}function b(w,x){for(m in w){if(!(m in x)){x[m]=e(w,m)}}}function d(w,x,y){return{next:function(){if(this.i<w.length){w[this.i](this.data).done(e(this,"handleDone")).fail(e(this,"handleFail"))}else{y.resolve(this.data)}},handleDone:function(z){this.i++;this.data=z;this.next()},handleFail:function(){if(x!=null){g.setTimeout(e(this,"next"),x)}},resolve:function(z){this.i=0;this.data=z;this.next()}}}function f(w){return function(y){var x=w(y);return{done:function(z){z(x);return this},fail:function(z){return this}}}}function l(x,y){var z={};for(var w in x){(function(B,A){if("uri" in A){A.mime=("mime" in A)?A.mime:"application/x-www-form-urlencoded";A.result=("result" in A)?A.result:"text";z[B]=function(C){return y.ajax({type:A.method,url:A.uri,data:C,dataType:A.result,contentType:A.mime})}}})(w,x[w])}return z}function a(w){return function(){var x=g.location.search.substring(1).split("&").map(function(z){return z.split(";")});var y=[];x.map(function(z){z.map(function(A){y.push(A)})});y=y.map(function(A){var z=A.split("=");if(z.length>1){return{name:z[0],value:decodeURIComponent(z[1].replace(/\+/g," "))}}else{return{name:z[0],value:""}}});return p(y,w)}}var o=function(x,w){$(x).children("div").each(function(){w[$(this).attr("class")]=this})};var q=function(w){return(function(x){return{makeFormHandler:function(y){return function(B,z,A){z.submit(function(C){return y(C,this,B,z,A)})}},makeDialogHandler:function(z){var y=this;return function(C,A,B){A.toggle(function(){console.log('make dialog "'+z+'"');y.templates[z](C,B);return false},function(){var D=C.find("."+z);D.remove();return false})}},makeListHandler:function(A,y){if(arguments.length<2){y=r}var z=this;return function(D,B,C){y(C).map(function(E){z.templates[A](B,E)})}},ClickRemove:function(A,y,z){A.click(function(B){A.remove();return false})},Up:function(A,y,z){y.click(function(){A.prev().before(A)})},Down:function(A,y,z){y.click(function(){A.next().after(A)})},SetInputs:function(y,z){if(arguments.length==0){y=r}if(arguments.length<2){return function(C,A,B){var D=y(B);for(n in D){C.find("[name="+n+"]").val(D[n])}}}else{return function(C,A,B){var D=y(B);z.map(function(E){if(E in D){C.find("[name="+E+"]").val(D[E])}})}}},AddFormHandlers:function(A,z,y){for(form in z){(function(B){A[B]=function(H,D,G,C,F){var E=p($(H.target).serializeArray(),$);if("validate" in z[B]){for(v in z[B].validate){if(!(z[B].validate[v])(G,C,E,F)){return false}}}y[B](E).done(z[B].done(E,G,C,F)).fail(z[B].fail(E,G,C,F));return false}})(form)}},loadTemplates:function(y){x.child=this;return x.loaderPromise(y)}}})((function(){return{templates:{},forms:{},addHandlers:function(A,x,z){for(s in x){var y=A.find(s);for(h in x[s]){x[s][h](A,y,z)}}return y},MakeTemplates:function(y,x){this.child.templates={};var z=this.child.templates;for(t in y){(function(B,A){if(B in x){z[B]=function(E,D){var C=$(y[B]).clone();A.addHandlers(C,x[B],D);E.append(C)}}else{z[B]=function(C){C.append($(y[B]).clone())}}})(t,this)}},loadTemplates:function(x){console.log("load templates "+x);return $.ajax({url:x,dataType:"html"})},handleTemplates:function(y){console.log("loading templates");var x=this;$(this.id).append(y);$(this.id+" :first-child ").children("div").each(function(){x.templates[$(this).attr("class")]=this});this.MakeTemplates(this.templates,this.handlers(this.child,this.templates,this.forms))},loaderPromise:function(x){var y=$.Deferred();d([this.loadTemplates,f(e(this,"handleTemplates"))],this.failRetry,y).resolve(x);return y},loaderUser:function(y){var x=this.loader(this.id,this.templates);this.MakeTemplates(this.templates,this.handlers(this.child,this.templates,this.forms));return x},init:function(x){this.id=("id" in x)?x.id:"#templates";this.handlers=("handlers" in x)?x.handlers:function(){return{}};this.failRetry=("failRetry" in x)?x.failRetry:60000;this.loaderPromise=("loader" in x)?((this.loader=x.loader),f(e(this,"loaderUser"))):this.loaderPromise;return this}}})().init(w))};g.InlineTemplateLoader=o;g.makeTemplates=q})(this);